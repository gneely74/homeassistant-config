###############################################################
## Presence
################################################################
- id: update_meta_tracker
  alias: "Update Device Meta Tracker"
  initial_state: 'on'
  trigger:
    # Delayed action for router-based and Owntracks trackers that are not 100% reliable
    - platform: state
      entity_id:
        - device_tracker.gradys_iphone
        - device_tracker.kates_iphone
      to: 'not_home'
      for: '00:07:00'
    - platform: state
      entity_id:
        - device_tracker.gradys_iphone
        - device_tracker.kates_iphone
      to: 'home'
      for: '00:00:30'
    - platform: state
      entity_id:
        - device_tracker.gradys_iphone
        - device_tracker.kates_iphone
    - platform: state
      entity_id:
        - device_tracker.gradys_iphone
        - device_tracker.kates_iphone
      to: 'home'
  action:
    - service: script.updatetracker
      data_template:
        entityid: '{{trigger.entity_id}}'
        fromstate: '{{trigger.from_state.state}}'
        tostate: '{{trigger.to_state.state}}'

#################################################################
## Security System
#################################################################

- id: abode_ios_notifications
  alias: Abode Actionable Notification
  trigger:
    - platform: event
      event_type: abode_alarm
  action:
    - service: notify.ios
      data:
        message: 'Abode alarm triggered!'
        data:
          push:
            badge: 0
            category: "abode_alarm"

- id: disarm_abode_from_away
  alias: 'Disarm Abode from Away'
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: input_select.abodestatus
      state: 'armed_away'
    - condition: state
      entity_id: input_boolean.abodeupdate
      state: 'on'
    - condition: template
      value_template: >
        {%- if states.automation.arm_abode.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.arm_abode.attributes.last_triggered)) > 240 }}
        {%- else -%}
          true
        {%- endif -%}
  trigger:
    - platform: state
      entity_id: group.household
      from: 'not_home'
      to: 'home'
    - platform: event
      event_type: ios.notification_action_fired
      event_data:
        actionName: DISARM_ABODE
  action:
     service: homeassistant.turn_on
     entity_id: script.abodestandby

- id: close_garage_door_notification
  alias: 'Close Garage Door Notification'
  initial_state: 'on'
  condition:
    condition: state
    entity_id: cover.garage_door_opener
    state: 'open'
  trigger:
    - platform: state
      entity_id: input_select.abodestatus
      to: 'armed_home'
    - platform: state
      entity_id: input_select.abodestatus
      to: 'armed_away'
  action:
    - service: notify.pushbullet
      data:
        message: "Garage Door Open"
        title: "Garage Door Open"
    - service: homeassistant.turn_on
      entity_id: script.notificationgaragedoor

- id: disarm_abode_at_night
  alias: 'Disarm Abode at night'
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: input_select.abodestatus
      state: 'armed_home'
    - condition: state
      entity_id: input_boolean.abodeupdate
      state: 'on'
  trigger:
   - platform: state
     entity_id:
       - device_tracker.gradys_iphone
       - device_tracker.kates_iphone
     from: 'not_home'
     to: 'home'
  action:
    service: homeassistant.turn_on
    entity_id: script.abodestandby

- id: abode_home_from_standby
  alias: 'Abode Home from Standby'
  initial_state: 'on'
  condition:
    condition: and
    conditions:
     - condition: state
       entity_id: input_select.abodestatus
       state: 'disarmed'
     - condition: time
       after: '22:15:00'
       before: '07:00:00'
     - condition: state
       entity_id: input_boolean.abodeupdate
       state: 'on'
     - condition: template
       value_template: >
         {%- if states.input_select.abodestatus.last_changed -%}
           {{ (as_timestamp(now()) - as_timestamp(states.input_select.abodestatus.last_changed)) > 300 }}
         {%- else -%}
           true
         {%- endif -%}
  trigger:
   - platform: time
     minutes: '/10'
     seconds: 00
  action:
     service: homeassistant.turn_on
     entity_id: script.abodehome

- id: abode_standby
  alias: 'Abode Standby'
  initial_state: 'on'
  condition:
    condition: and
    conditions:
     - condition: state
       entity_id: group.household
       state: 'home'
     - condition: time
       after: '08:15:00'
       before: '21:45:00'
     - condition: state
       entity_id: input_boolean.abodeupdate
       state: 'on'
     - condition: template
       value_template: >
         {%- if states.input_select.abodestatus.last_changed -%}
           {{ (as_timestamp(now()) - as_timestamp(states.input_select.abodestatus.last_changed)) > 300 }}
         {%- else -%}
           true
         {%- endif -%}
     - condition: or
       conditions:
        - condition: state
          entity_id: input_select.abodestatus
          state: 'armed_home'
        - condition: state
          entity_id: input_select.abodestatus
          state: 'armed_away'
  trigger:
   - platform: time
     minutes: '/10'
     seconds: 00
  action:
     service: homeassistant.turn_on
     entity_id: script.abodestandby

- id: abode_arm
  alias: 'Arm Abode'
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.abodeupdate
      state: 'on'
    - condition: template
      value_template: >
        {%- if states.automation.disarm_abode_from_away.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.disarm_abode_from_away.attributes.last_triggered)) > 240 }}
        {%- else -%}
          true
        {%- endif -%}
    - condition: template
      value_template: "{{ states.input_select.abodestatus.state != 'armed_away' }}"
  trigger:
    - platform: state
      entity_id: group.household
      from: 'home'
      to: 'not_home'
    - platform: state
      entity_id: group.household
      from: 'home'
      to: 'not_home'
      for: '00:10:00'
  action:
     service: homeassistant.turn_on
     entity_id: script.abodeaway

- id: abode_home_at_night
  alias: 'Abode Home at night'
  initial_state: 'on'
  condition:
    condition: and
    conditions:
     - condition: state
       entity_id: input_boolean.abodeupdate
       state: 'on'
     - condition: state
       entity_id: group.household
       state: 'home'
  trigger:
    platform: time
    at: '22:00:00'
  action:
     service: homeassistant.turn_on
     entity_id: script.abodehome

- id: abode_disarm_morning
  alias: 'Disarm Abode in the morning'
  initial_state: 'on'
  condition:
    condition: and
    conditions:
     - condition: state
       entity_id: group.household
       state: 'home'
     - condition: state
       entity_id: input_boolean.abodeupdate
       state: 'on'
  trigger:
    platform: time
    at: '07:00:00'
  action:
     service: homeassistant.turn_on
     entity_id: script.abodestandby

- id: enable_recording
  alias: Enable Recording
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: input_boolean.startrecording
    to: 'on'
  action:
    service: switch.turn_on
    entity_id: switch.foscam_record

- id: disable_recording
  alias: Disable Recording
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: input_boolean.startrecording
    to: 'off'
  action:
    service: switch.turn_off
    entity_id: switch.foscam_record

- id: disable_thermostat_away_mode
  alias: 'Disable thermostat away'
  initial_state: 'on'
  condition:
    - condition: template
      value_template: >
        {{states.input_select.abodestatus.state == 'disarmed' and states.group.thermostats.state == 'on'}}
  trigger:
   - platform: time
     minutes: '/5'
     seconds: 00
  action:
    service: homeassistant.turn_off
    data_template:
      entity_id: >
        {%- if states.switch.downstairs_away.state == 'on' -%}
          switch.downstairs_away
        {%- elif states.switch.upstairs_away.state == 'on' -%}
          switch.upstairs_away
        {%- elif states.switch.lyric_hold.state == 'on' -%}
          switch.lyric_hold
        {%- endif -%}

- id: enable_thermostat_away_mode
  alias: 'Enable thermostat away'
  initial_state: 'on'
  condition:
    - condition: or
      conditions:
        - condition: template
          value_template: >
            {{states.input_select.abodestatus.state == 'armed_away' and states.switch.downstairs_away.state == 'off'}}
        - condition: template
          value_template: >
            {{states.input_select.abodestatus.state == 'armed_away' and states.switch.upstairs_away.state == 'off'}}
        - condition: template
          value_template: >
            {{states.input_select.abodestatus.state == 'armed_away' and states.switch.lyric_hold.state == 'off'}}
  trigger:
   - platform: time
     minutes: '/5'
     seconds: 00
  action:
    service: homeassistant.turn_on
    data_template:
      entity_id: >
        {%- if states.switch.downstairs_away.state == 'off' -%}
          switch.downstairs_away
        {%- elif states.switch.upstairs_away.state == 'off' -%}
          switch.upstairs_away
        {%- elif states.switch.lyric_hold.state == 'off' -%}
          switch.lyric_hold
        {%- endif -%}


- id: notify_camera_pictures
  alias: 'Notify camera pictures'
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: input_select.abodestatus
      state: 'armed_away'
    - condition: template
      value_template: >
        {%- if states.automation.notify_camera_pictures.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.notify_camera_pictures.attributes.last_triggered)) > 300 }}
        {%- else -%}
          true
        {%- endif -%}
    - condition: template
      value_template: >
        {%- if trigger.entity_id == "binary_sensor.backyard_field_detection" or trigger.entity_id == "binary_sensor.backyard_line_crossing" -%}
        {{((as_timestamp(now()) - as_timestamp(states.binary_sensor.backyard_motion.attributes.last_tripped_time)))|round|abs < 30}}
        {%- elif trigger.entity_id == "binary_sensor.driveway_field_detection" or trigger.entity_id == "binary_sensor.driveway_line_crossing" -%}
        {{((as_timestamp(now()) - as_timestamp(states.binary_sensor.driveway_motion.attributes.last_tripped_time)))|round|abs < 30}}
        {%- elif trigger.entity_id == "binary_sensor.patio_field_detection" or trigger.entity_id == "binary_sensor.patio_line_crossing" -%}
        {{((as_timestamp(now()) - as_timestamp(states.binary_sensor.patio_motion.attributes.last_tripped_time)))|round|abs < 30}}
        {%- elif trigger.entity_id == "binary_sensor.porch_field_detection" or trigger.entity_id == "binary_sensor.porch_line_crossing" -%}
        {{((as_timestamp(now()) - as_timestamp(states.binary_sensor.porch_motion.attributes.last_tripped_time)))|round|abs < 30}}
        {%- else -%}
          true
        {%- endif -%}
  trigger:
   - platform: state
     entity_id:
       - binary_sensor.backyard_field_detection
       - binary_sensor.driveway_field_detection
       - binary_sensor.patio_field_detection
       - binary_sensor.porch_field_detection
       - binary_sensor.backyard_line_crossing
       - binary_sensor.driveway_line_crossing
       - binary_sensor.patio_line_crossing
       - binary_sensor.porch_line_crossing
     from: 'off'
     to: 'on'
  action:
    - service: notify.ios
      data_template:
        message: "Check {{ trigger.entity_id.split('.')[1].split('_')[0] }} camera."
        data:
          push:
            category: camera
          entity_id: "camera.{{ trigger.entity_id.split('.')[1].split('_')[0] }}"
          attachment:
            url: "{{ states.camera[trigger.entity_id.split('.')[1].split('_')[0]].attributes.entity_picture }}"
            content-type: jpg
    - service: logbook.log
      data_template:
        name: "Camera activity: "
        message: >-
          {%- for state in states if state.entity_id == trigger.entity_id -%}
            {{ state.attributes.friendly_name }} activated at {{ as_timestamp(now()) | timestamp_custom('%I:%M:%S %p', true) }}.
          {%- endfor -%}
    - service: logbook.log
      data_template:
        name: "Motion detected: "
        message: >-
          {%- if trigger.entity_id == "binary_sensor.backyard_field_detection" or trigger.entity_id == "binary_sensor.backyard_line_crossing" -%}
            {{(as_timestamp(now()) - as_timestamp(states.binary_sensor.backyard_motion.attributes.last_tripped_time))|round(2)}} seconds ago.
          {%- elif trigger.entity_id == "binary_sensor.driveway_field_detection" or trigger.entity_id == "binary_sensor.driveway_line_crossing" -%}
            {{(as_timestamp(now()) - as_timestamp(states.binary_sensor.driveway_motion.attributes.last_tripped_time))|round(2)}} seconds ago.
          {%- elif trigger.entity_id == "binary_sensor.patio_field_detection" or trigger.entity_id == "binary_sensor.patio_line_crossing" -%}
            {{(as_timestamp(now()) - as_timestamp(states.binary_sensor.patio_motion.attributes.last_tripped_time))|round(2)}} seconds ago.
          {%- elif trigger.entity_id == "binary_sensor.porch_field_detection" or trigger.entity_id == "binary_sensor.porch_line_crossing" -%}
            {{(as_timestamp(now()) - as_timestamp(states.binary_sensor.porch_motion.attributes.last_tripped_time))|round(2)}} seconds ago.
          {%- endif -%}

- id: ring_camera_notification
  alias: 'Notify Ring camera'
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: input_select.abodestatus
      state: 'armed_away'
  trigger:
   - platform: state
     entity_id: sensor.ringvideourl
  action:
    - service: notify.ios
      data_template:
        message: "Check Ring camera."
        data:
          push:
            category: camera
          entity_id: camera.front_door
          attachment:
            url: "{{ states.camera.front_door.attributes.video_url }}"

- id: ring_download_video
  alias: 'Ring download video'
  initial_state: 'on'
  trigger:
   - platform: state
     entity_id: sensor.ringvideourl
  action:
    - service: downloader.download_file
      data_template:
        url: "{{ states.camera.front_door.attributes.video_url }}"
        subdir: "{{'ring_' + states.camera.front_door.attributes.friendly_name.lower().replace(' ', '_')}}"
        overwrite: True
        filename: "{{states.camera.front_door.attributes.friendly_name.lower().replace(' ', '_')}}"

#################################################################
## HASS Related
#################################################################

- id: battery_alert
  alias: 'Battery Alert'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: sensor.battery_status
  action:
    - service: persistent_notification.create
      data_template:
        title: Low Battery levels
        notification_id: low-battery-alert
        message: >
          Check battery: {{ states.sensor.battery_status.state }}
    - service: notify.pushbullet
      data_template:
        title: "Battery status"
        message: >
          Check battery: {{ states.sensor.battery_status.state }}

- id: heal_zwave_network
  alias: Heal Z-Wave Network
  initial_state: 'on'
  trigger:
    platform: time
    at: '2:31:00'
  action:
    service: zwave.heal_network

- id: update_available_notification
  alias: "Update Available Notification"
  initial_state: 'on'
  trigger:
    platform: template
    value_template: "{{states.sensor.pypi_hass_version.state == states.sensor.current_version.state}}"
  action:
    - service: notify.pushbullet
      data:
        message: "HomeAssistant {{ states('states.sensor.pypi_hass_version.state') }} is now available"
        title: "Update HASS"
    - service: persistent_notification.create
      data:
        title: "Update Available"
        message: >
          Home Assistant {{ states('states.sensor.pypi_hass_version.state') }} is available, please update.
        notification_id: "update_available"

- id: change_current_theme
  alias: 'Change Current Theme'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: input_select.current_theme
  action:
    - service: frontend.set_theme
      data_template:
        name: '{{states.input_select.current_theme.state}}'

#################################################################
## Commute Times
#################################################################

- id: morning_commute
  alias: "Morning Commute"
  initial_state: 'on'
  condition:
    condition: and
    conditions:
     - condition: time
       after: '08:15:00'
       before: '11:00:00'
     - condition: time
       weekday:
         - mon
         - tue
         - wed
         - thu
         - fri
     - condition: state
       entity_id: device_tracker.meta_grady
       state: 'home'
  trigger:
    platform: numeric_state
    entity_id: sensor.morning_commute
    below: 43
  action:
    - service: notify.pushbullet
      data:
        message: Commute time is 43 minutes
        title: Leave for Work
        target: device/myiPhone
    - service: homeassistant.turn_on
      entity_id: script.notificationleavework

- id: evening_commute
  alias: "Evening Commute"
  initial_state: 'on'
  condition:
    condition: and
    conditions:
     - condition: time
       after: '17:00:00'
       before: '20:00:00'
     - condition: time
       weekday:
         - mon
         - tue
         - wed
         - thu
         - fri
     - condition: template
       value_template: >
         {%- if states.device_tracker.meta_grady -%}
           {{ states.device_tracker.meta_grady.state != 'home' }}
         {%- else -%}
           false
         {%- endif -%}
  trigger:
    platform: template
    value_template: >
      {%- if states.sensor.grady_to_home.attributes.duration_in_traffic -%}
        {{(states.sensor.grady_to_home.attributes.duration_in_traffic.split(' ')[0]|int) / (states.sensor.grady_to_home.attributes.duration.split(' ')[0]|int) < 1.25}}
      {%- else -%}
        false
      {%- endif -%}
  action:
    service: notify.pushbullet
    data_template:
      message: Commute time is {{states.sensor.grady_to_home.attributes.duration_in_traffic.split(' ')[0]|int}} minutes
      title: Leave for Home
      target: device/myiPhone

- id: plexspy_notification
  alias: "Plex Spy notification"
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: sensor.plexspy
  action:
    - service: notify.pushbullet
      data_template:
        message: >
          {%- if states.sensor.plexspy.attributes -%}
            {% set space = joiner(' ') %}
            {%- for attr in states.sensor.plexspy.attributes -%}
             {%- if not attr=="friendly_name" and not attr=="unit_of_measurement" and not attr=="homebridge_hidden"-%}
              {{space()}}{{attr}} is watching {{states.sensor.plexspy.attributes[attr]}}.
             {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        title: "Plex {{ trigger.to_state.state }} people streaming. "
        target: device/myiPhone
    - service: logbook.log
      data_template:
        name: "Plex {{ trigger.to_state.state }} people streaming. "
        message: >
          {%- if states.sensor.plexspy.attributes -%}
            {% set space = joiner(' ') %}
            {%- for attr in states.sensor.plexspy.attributes -%}
             {%- if not attr=="friendly_name" and not attr=="unit_of_measurement" and not attr=="homebridge_hidden"-%}
              {{space()}}{{attr}} is watching {{states.sensor.plexspy.attributes[attr]}}.
             {%- endif -%}
            {%- endfor -%}
          {%- endif -%}

#################################################################
## Home Automation Related
#################################################################

- id: micube_test
  alias: MiCube event test
  initial_state: 'off'
  trigger:
    platform: event
    event_type: cube_action
    event_data:
      entity_id: binary_sensor.cube_158d0001035aa7
  action:
    - service: logbook.log
      data_template:
        name: "MiCube event: "
        message: >
          {%- if trigger.event.data.action_value -%}
            {{trigger.event.data.action_type}} and {{trigger.event.data.action_value}}
          {%- else -%}
            {{trigger.event.data.action_type}}
          {%- endif -%}

- id: micube_volume
  alias: "MiCube rotate - Volume livingroom home"
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: media_player.livingroomsonos
      state: 'playing'
  trigger:
    platform: event
    event_type: cube_action
    event_data:
      entity_id: binary_sensor.cube_158d0001035aa7
      action_type: rotate
  action:
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.livingroomsonos
        volume_level: >
              {% set state = (states.media_player.livingroomsonos.attributes.volume_level + (trigger.event.data.action_value|int)/90)|round(2) -%}
              {%-  if state > 1 -%}
                 {%- set state  = 1 -%}
              {%-  elif state < 0 -%}
                 {%- set state  = 0 -%}
              {%- endif %}
              {{ state }}
    - service: notify.shield
      data_template:
        title: "Home Assistant"
        message: >
          {%- if trigger.event.data.action_value > 0 -%}
            Volume increased to {{ (states.media_player.livingroomsonos.attributes.volume_level + (trigger.event.data.action_value|int)/90)|round(2) }}
          {%- else -%}
            Volume lowered to {{ (states.media_player.livingroomsonos.attributes.volume_level + (trigger.event.data.action_value|int)/90)|round(2) }}
          {%- endif -%}
    - service: logbook.log
      data_template:
        name: "Volume changed: "
        message: "{{ (states.media_player.livingroomsonos.attributes.volume_level + (trigger.event.data.action_value|int)/90)|round(2) }}"
- id: prevent_overcharging
  alias: 'Prevent overcharging'
  initial_state: 'on'
  trigger:
    - platform: numeric_state
      entity_id: sensor.wemopowerused
      below: 2
  condition:
    - condition: state
      entity_id: switch.wemoinsight
      state: 'on'
  action:
     service: switch.turn_off
     data:
       entity_id: switch.wemoinsight

- id: ensure_switches_on
  alias: 'Ensure smart-switches are on'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
        - device_tracker.lifx5
        - device_tracker.lifx3
      to: 'not_home'
  action:
    - service: notify.pushbullet
      data_template:
        title: "Check {{ trigger.to_state.name }} Switch"
        message: >
          Check switch: {{ trigger.to_state.name }}

- id: garage_lights_on
  alias: 'Turn on garage lights when door opened'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.garage_entry_door
      from: 'off'
      to: 'on'
  condition:
    - condition: or
      conditions:
       - condition: state
         entity_id: cover.garagedoor
         state: 'closed'
       - condition: state
         entity_id: sun.sun
         state: 'below_horizon'
  action:
     service: light.turn_on
     data:
       entity_id: light.lifx5
       brightness: 255

- id: garage_lights_off
  alias: 'Turn off garage lights'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.garage_entry_door
      to: 'off'
      for: '00:00:30'
  condition:
    - condition: state
      entity_id: light.lifx5
      state: 'on'
  action:
     service: light.turn_off
     entity_id: light.lifx5

- id: kitchen_light_brightness
  alias: 'Kitchen light brightness'
  initial_state: 'on'
  trigger:
   - platform: state
     entity_id: light.kitchen_lights
     from: 'off'
     to: 'on'
  condition:
    - condition: template
      value_template: '{{ trigger.from_state.state == "off" }}'
  action:
     service: light.turn_on
     data:
       entity_id: light.kitchen_lights
       brightness: 200

- id: turn_off_xiaomi
  alias: 'Turn off Xiaomi Gateway light'
  initial_state: 'on'
  trigger:
   - platform: numeric_state
     entity_id: sensor.illumination_34ce00813670
     above: 600
  condition:
    - condition: state
      entity_id: light.gateway_light_34ce00813670
      state: 'on'
  action:
    - service: light.turn_off
      entity_id: light.gateway_light_34ce00813670

- id: change_xiaomi_color
  alias: 'Change Xiaomi color'
  initial_state: 'on'
  condition:
    - condition: time
      after: '19:15:00'
      before: '07:45:00'
    - condition: state
      entity_id: binary_sensor.living_room_occupancy
      state: 'on'
  trigger:
   - platform: time
     minutes: '/15'
     seconds: 00
  action:
     service: light.turn_on
     entity_id: light.gateway_light_34ce00813670
     data_template:
       brightness: 255
       rgb_color: ['{{ (range(0, 255)|random) }}','{{ (range(0, 255)|random) }}','{{ (range(0, 255)|random) }}']

- id: change_leeo_color
  alias: 'Change Leeo color'
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: device_tracker.leeoalert
      state: 'home'
    - condition: time
      after: '19:15:00'
      before: '07:45:00'
    - condition: state
      entity_id: binary_sensor.living_room_occupancy
      state: 'on'
  trigger:
   - platform: time
     minutes: '/15'
     seconds: 00
  action:
     service: ifttt.trigger
     data_template: {"event":"leeocolor", "value1":"{{ '{:02x}{:02x}{:02x}'.format(range(0, 255) | random, range(0, 255) | random, range(0, 255) | random) }}"}

- id: change_leeoup_color
  alias: 'Change Leeo upstairs color'
  initial_state: 'on'
  condition:
    - condition: time
      after: '19:15:00'
      before: '07:45:00'
  trigger:
   - platform: time
     minutes: '/15'
     seconds: 00
  action:
     service: ifttt.trigger
     data_template: {"event":"leeocolorup", "value1":"{{ '{:02x}{:02x}{:02x}'.format(range(0, 255) | random, range(0, 255) | random, range(0, 255) | random) }}"}

- id: frontyard_lights
  alias: 'Turn on frontyard lights'
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: sun.sun
      state: 'below_horizon'
    - condition: time
      after: '19:00:00'
      before: '05:00:00'
  trigger:
   - platform: state
     entity_id:
       - binary_sensor.ring_front_door_motion
     from: 'off'
     to: 'on'
  action:
    - service: switch.turn_on
      entity_id:
        - switch.driveway
        - switch.wemoporch

- id: frontyard_lights_off_after_ring
  alias: 'Turn off frontyard lights after Ring'
  initial_state: 'on'
  condition:
    - condition: template
      value_template: >
        {%- if states.binary_sensor.ring_front_door_motion.last_changed -%}
          {{(as_timestamp(now()) - as_timestamp(states.binary_sensor.ring_front_door_motion.last_changed)) > 200}}
        {%- else -%}
          false
        {%- endif -%}
    - condition: or
      conditions:
        - condition: state
          entity_id: switch.driveway
          state: 'on'
        - condition: state
          entity_id: switch.wemoporch
          state: 'on'
  trigger:
   - platform: time
     minutes: '/5'
  action:
    - service: switch.turn_off
      entity_id:
        - switch.driveway
        - switch.wemoporch

- id: lifx_party_mode
  alias: "Turn Lifx Party Mode On"
  initial_state: 'on'
  trigger:
    - platform: time
      seconds: '/3'
  condition:
    - condition: state
      entity_id: input_boolean.partymode
      state: 'on'
  action:
    - service: light.turn_on
      entity_id: light.lifxnrkitchen
      data_template:
        rgb_color: ['{{ (range(0, 255)|random) }}', '{{ (range(0, 255)|random) }}', '{{ (range(0, 255)|random) }}']
        brightness: 200
        transition: '{{ (range(1, 2)|random) }}'
    - service: light.turn_on
      entity_id: light.lifxnrguest
      data_template:
        rgb_color: ['{{ (range(0, 255)|random) }}', '{{ (range(0, 255)|random) }}', '{{ (range(0, 255)|random) }}']
        brightness: 200
        transition: '{{ (range(1, 2)|random) }}'
    - service: light.turn_on
      entity_id: light.lifx3
      data_template:
        rgb_color: ['{{ (range(0, 255)|random) }}', '{{ (range(0, 255)|random) }}', '{{ (range(0, 255)|random) }}']
        brightness: 200
        transition: '{{ (range(1, 2)|random) }}'
- id: lifx_party_mode_off
  alias: "Turn Lifx Party Mode Off"
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: input_boolean.partymode
      to: 'off'
  action:
    - service: light.turn_on
      entity_id: group.living_room_lights
      data:
        rgb_color: [255, 255, 255]
        brightness: 250
        color_temp: 285

- id: outdoor_light_at_night
  alias: Outdoor lights at night
  initial_state: 'on'
  trigger:
    platform: sun
    event: sunset
    offset: "00:45:00"
  action:
    - service: switch.turn_on
      entity_id:
        - switch.driveway

- id: outdoor_light_off
  alias: Outdoor light Off
  initial_state: 'on'
  trigger:
    platform: sun
    event: sunset
    offset: "01:30:00"
  action:
    - service: switch.turn_off
      entity_id:
        - switch.driveway

- id: driveway_light_off_during_the_day
  alias: Driveway light Off during the day
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: switch.driveway
    to: 'on'
  condition:
    - condition: state
      entity_id: sun.sun
      state: 'above_horizon'
  action:
    - service: switch.turn_off
      entity_id:
        - switch.driveway
        - switch.wemoporch

- id: set_hvac_mode
  alias: 'Set HVAC Mode'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: sensor.hvacmode
      to: 'heat'
    - platform: state
      entity_id: sensor.hvacmode
      to: 'cool'
  action:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.hvacmode
        option: '{{ trigger.to_state.state }}'
- id: reset_garage_relay
  alias: 'Reset Garage Relay'
  initial_state: 'on'
  trigger:
    - platform: time
      seconds: '/5'
  condition:
    - condition: state
      entity_id: switch.garage_relay_switch
      state: "on"
  action:
    - service: switch.turn_off
      entity_id: switch.garage_relay_switch

- id: open_garage_door_when_someone_home
  alias: 'Open Garage door when someone home'
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: binary_sensor.garagedoor
      state: 'off'
      for: '00:02:00'
    - condition: state
      entity_id: input_boolean.abodeupdate
      state: 'on'
    - condition: template
      value_template: >
        {%- if states.automation.open_garage_door_when_someone_home.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.open_garage_door_when_someone_home.attributes.last_triggered)) > 150 }}
        {%- else -%}
          true
        {%- endif -%}
    - condition: template
      value_template: >
        {%- if states.automation.update_ha_after_startup.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.update_ha_after_startup.attributes.last_triggered)) > 120 }}
        {%- else -%}
          true
        {%- endif -%}
    - condition: template
      value_template: >
        {%- if states.automation.arm_abode.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.arm_abode.attributes.last_triggered)) > 240 }}
        {%- else -%}
          true
        {%- endif -%}
  trigger:
    - platform: state
      entity_id:
        - device_tracker.meta_kate
        - device_tracker.meta_grady
      from: 'not_home'
      to: 'home'
  action:
    - service: switch.turn_on
      entity_id: switch.garage_relay_switch

- id: close_garage_door_when_abode_is_home_or_away
  alias: 'Close garage door when Abode is Home or Away'
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: binary_sensor.garage_door
      state: 'on'
    - condition: template
      value_template: >
        {%- if states.automation.close_garage_door_when_abode_is_home_or_away.attributes.last_triggered  -%}
          {{(as_timestamp(now()) - as_timestamp(states.automation.close_garage_door_when_abode_is_home_or_away.attributes.last_triggered)) > 60}}
        {%- else -%}
          true
        {%- endif -%}
    - condition: or
      conditions:
       - condition: state
         entity_id: input_select.abodestatus
         state: 'armed_home'
       - condition: state
         entity_id: input_select.abodestatus
         state: 'armed_away'
  trigger:
    - platform: time
      minutes: '/5'
  action:
    - service: switch.turn_on
      entity_id: switch.garage_relay_switch

- id: sensors_changed_when_nobody_home
  alias: 'Sensors changed when nobody is home'
  initial_state: 'on'
  condition:
    condition: state
    entity_id: input_select.abodestatus
    state: 'armed_away'
    for:
      minutes: 10
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.garagedoor
        - binary_sensor.back_door
        - binary_sensor.garage_entry_door
        - binary_sensor.front_door
        - binary_sensor.motion_sensor_158d00016daecc
        - binary_sensor.motion_sensor_158d00016612af
      from: 'off'
      to: 'on'
  action:
    - service: light.turn_on
      data:
        entity_id: group.all_lights
    - service: notify.pushbullet
      data_template:
        title: "Alarm!"
        message: "The {{ trigger.to_state.name }} was changed to {{ trigger.to_state.state }} while no one is home - {{ as_timestamp(now()) | timestamp_custom('%I:%M:%S %p %d-%b-%Y', true) }}"
    - service: homeassistant.turn_on
      entity_id: script.notificationalarm

- id: sound_abode_alarm_notification
  alias: 'Sound alarm using notifications'
  initial_state: 'on'
  trigger:
    - platform: event
      event_type: ios.notification_action_fired
      event_data:
        actionName: SOUND_ALARM
  action:
    - service: light.turn_on
      data:
        entity_id: group.all_lights
    - service: homeassistant.turn_on
      entity_id: script.notificationalarm

- id: abode_update_ios_notification
  alias: Abode Update Actionable Notification
  initial_state: 'on'
  trigger:
    platform: time
    minutes: /30
    seconds: 00
  condition:
    condition: state
    entity_id: input_boolean.abodeupdate
    state: 'off'
  action:
    - service: notify.ios_gradys_iphone
      data:
        message: 'Enable Abode updates?'
        data:
          push:
            badge: 0
            category: "abode_updates"

- id: turn_on_abode_updates
  alias: 'Turn on Abode updates'
  initial_state: 'on'
  trigger:
    - platform: event
      event_type: ios.notification_action_fired
      event_data:
        actionName: ENABLE_ABODE_UPDATES
  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.abodeupdate

- id: turn_on_lights_randomly
  alias: Turn lights on randomly
  initial_state: 'on'
  condition:
    condition: state
    entity_id: input_select.abodestatus
    state: 'armed_away'
  trigger:
    platform: sun
    event: sunset
    offset: "00:45:00"
  action:
    - service: light.turn_on
      data:
        entity_id: group.living_room_lights

- id: turn_off_lights_in_2_hours
  alias: Turn off lights 2 hours
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: input_select.abodestatus
      state: 'armed_away'
    - condition: state
      entity_id: group.living_room_lights
      state: 'on'
  trigger:
    platform: sun
    event: sunset
    offset: "02:45:00"
  action:
    - service: light.turn_off
      data:
        entity_id: group.living_room_lights